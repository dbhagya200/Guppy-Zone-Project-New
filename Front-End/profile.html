<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Guppy Zone-Profile</title>
    <link href="plugins/jquery-ui/jquery-ui.min.css" rel="stylesheet">
    <!-- Bootstrap -->
    <link href="plugins/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="plugins/font-awesome/css/font-awesome.min.css" rel="stylesheet">
    <!-- Owl Carousel -->
    <link href="plugins/slick-carousel/slick/slick.css" rel="stylesheet">
    <link href="plugins/slick-carousel/slick/slick-theme.css" rel="stylesheet">
    <!-- Fancy Box -->
    <link href="plugins/fancybox/jquery.fancybox.pack.css" rel="stylesheet">
    <link href="plugins/jquery-nice-select/css/nice-select.css" rel="stylesheet">
    <link href="plugins/seiyria-bootstrap-slider/dist/css/bootstrap-slider.min.css" rel="stylesheet">
    <!-- CUSTOM CSS -->
    <link href="css/style.css" rel="stylesheet">

    <!-- FAVICON -->
    <link rel="shortcut icon" href="img/logo-new.png" type="image/x-icon" />

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body class="body-wrapper">
<section>
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <nav class="navbar navbar-expand-lg  navigation">
                    <a class="navbar-brand" href="pages/index.html">
                        <img style="width: 3rem;height: 3rem" src="img/logo-2.png" alt="">
                        <span>Guppy Zone</span></a>
                    </a>
                    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse" id="navbarSupportedContent">
                        <ul class="navbar-nav ml-auto main-nav ">
                            <li class="nav-item active">
                                <a class="nav-link" href="home.html">Home</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="dashboardAdds.html">Dashboard</a>
                            </li>
                            <li class="nav-item dropdown dropdown-slide">
                                <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    Pages <span><i class="fa fa-angle-down"></i></span>
                                </a>
                                <!-- Dropdown list -->
                                <div class="dropdown-menu dropdown-menu-right">
                                    <a class="dropdown-item" href="categoriesAdd.html">Category</a>
                                    <a class="dropdown-item" href="blog.html">Blog</a>
                                    <a class="dropdown-item" href="s-comment.html">Leave Some Comments</a>
                                </div>
                            </li>
                            <li class="nav-item dropdown dropdown-slide">
                                <a class="nav-link dropdown-toggle" href="" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    Others <span><i class="fa fa-angle-down"></i></span>
                                </a>
                                <!-- Dropdown list -->
                                <div class="dropdown-menu dropdown-menu-right">
                                    <a class="dropdown-item" href="#">Chatting</a>
                                    <!--									<a class="dropdown-item" href="#">Another action</a>-->
                                    <!--									<a class="dropdown-item" href="#">Something else here</a>-->
                                </div>
                            </li>
                        </ul>
                        <ul class="navbar-nav ml-auto mt-10">
                            <li class="nav-item">
                                <a class="nav-link login-button" href="profile.html">Profile</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link add-button" href="postAdd.html"><i class="fa fa-plus-circle"></i> Add Post</a>
                            </li>
                        </ul>
                    </div>
                </nav>
            </div>
        </div>
    </div>
</section>

<!--==================================
=            User Profile            =
===================================-->

<section class="user-profile section">
    <div class="container">
        <div class="row">
            <div class="col-md-10 offset-md-1 col-lg-4 offset-lg-0">
                <div class="sidebar">
                    <!-- User Widget -->
                    <div class="widget user-dashboard-profile">
                        <!-- User Image -->
                        <div class="profile-thumb">
                            <img src="images/user/user-thumb.jpg" alt="" class="rounded-circle" id="profileImage">
                        </div>
                        <!-- User Name -->
                        <h5 class="text-center" id="name">Samanta Doe</h5>
<!--                        <p id="data">Joined February 06, 2017</p>-->
                    </div>
                    <!-- Dashboard Links -->
                    <div class="widget user-dashboard-menu">
                        <ul>
                            <li>
                                <a href="dashboardAdds.html"><i class="fa fa-user"></i> My Ads</a>
                            </li>
<!--                            <li>-->
<!--                                <a href="dashboard-favourite-ads.html"><i class="fa fa-bookmark-o"></i> Favourite Ads <span>5</span></a>-->
<!--                            </li>-->
<!--                            <li>-->
<!--                                <a href="dashboard-archived-ads.html"><i class="fa fa-file-archive-o"></i>Archeved Ads <span>12</span></a>-->
<!--                            </li>-->
<!--                            <li>-->
<!--                                <a href="dashboard-pending-ads.html"><i class="fa fa-bolt"></i> Pending Approval<span>23</span></a>-->
<!--                            </li>-->
                            <li>
                                <a href="index-1.html"><i class="fa fa-cog"></i> Logout</a>
                            </li>
                            <li>
                                <a href="delete-account.html"><i class="fa fa-power-off"></i>Delete Account</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-md-10 offset-md-1 col-lg-8 offset-lg-0">
                <!-- Edit Personal Info -->
                <div class="widget personal-info">
                    <h3 class="widget-header user">Edit Personal Information</h3>
                    <form action="#" id="profile-form">
                        <!-- First Name -->
                        <div class="form-group">
                            <label for="first-name">First Name</label>
                            <input type="text" class="form-control" id="first-name">
                        </div>
                        <!-- Last Name -->
                        <div class="form-group">
                            <label for="last-name">Last Name</label>
                            <input type="text" class="form-control" id="last-name">
                        </div>
                        <div class="form-group">
                            <label for="last-name">Email</label>
                            <input type="email" class="form-control" id="email">
                        </div>
                        <!-- File chooser -->
                        <div class="form-group choose-file">
                            <i class="fa fa-user text-center"></i>
                            <input type="file" class="form-control-file d-inline" id="input-file">
                        </div>
                        <!-- Comunity Name -->
                        <div class="form-group">
                            <label for="address"> Address</label>
                            <input type="text" class="form-control" id="address">
                        </div>
                        <div class="form-group">
                            <label for="contact"> Contact Number</label>
                            <input type="text" class="form-control" id="contact">
                        </div>
                        <!-- Submit button -->
                        <button class="btn btn-transparent">Save My Changes</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

<!--============================
=            Footer            =
=============================-->

<footer class="footer section section-sm">
    <!-- Container Start -->
    <div class="container">
        <div class="row">
            <div class="col-lg-3 col-md-7 offset-md-1 offset-lg-0">
                <!-- About -->
                <div class="block about">
                    <!-- footer logo -->
                    <img src="images/logo-footer.png" alt="">
                    <!-- description -->
                    <p class="alt-color">Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>
                </div>
            </div>
            <!-- Link list -->
            <div class="col-lg-2 offset-lg-1 col-md-3">
                <div class="block">
                    <h4>Site Pages</h4>
                    <ul>
                        <li><a href="#">Boston</a></li>
                        <li><a href="#">How It works</a></li>
                        <li><a href="#">Deals & Coupons</a></li>
                        <li><a href="#">Articls & Tips</a></li>
                        <li><a href="#">Terms of Services</a></li>
                    </ul>
                </div>
            </div>
            <!-- Link list -->
            <div class="col-lg-2 col-md-3 offset-md-1 offset-lg-0">
                <div class="block">
                    <h4>Admin Pages</h4>
                    <ul>
                        <li><a href="#">Boston</a></li>
                        <li><a href="#">How It works</a></li>
                        <li><a href="#">Deals & Coupons</a></li>
                        <li><a href="#">Articls & Tips</a></li>
                        <li><a href="#">Terms of Services</a></li>
                    </ul>
                </div>
            </div>
            <!-- Promotion -->
            <div class="col-lg-4 col-md-7">
                <!-- App promotion -->
                <div class="block-2 app-promotion">
                    <a href="">
                        <!-- Icon -->
                        <img src="images/footer/phone-icon.png" alt="mobile-icon">
                    </a>
                    <p>Get the Dealsy Mobile App and Save more</p>
                </div>
            </div>
        </div>
    </div>
    <!-- Container End -->
</footer>
<!-- Footer Bottom -->
<footer class="footer-bottom">
    <!-- Container Start -->
    <div class="container">
        <div class="row">
            <div class="col-sm-6 col-12">
                <!-- Copyright -->
                <div class="copyright">
                    <p>Copyright © 2016. All Rights Reserved</p>
                </div>
            </div>
            <div class="col-sm-6 col-12">
                <!-- Social Icons -->
                <ul class="social-media-icons text-right">
                    <li><a class="fa fa-facebook" href=""></a></li>
                    <li><a class="fa fa-twitter" href=""></a></li>
                    <li><a class="fa fa-pinterest-p" href=""></a></li>
                    <li><a class="fa fa-vimeo" href=""></a></li>
                </ul>
            </div>
        </div>
    </div>
    <!-- Container End -->
    <!-- To Top -->
    <div class="top-to">
        <a id="top" class="" href=""><i class="fa fa-angle-up"></i></a>
    </div>
</footer>

<!-- JAVASCRIPTS -->
<!--<script src="plugins/jquery/jquery.min.js"></script>-->
<!--<script src="plugins/jquery-ui/jquery-ui.min.js"></script>-->
<script src="plugins/tether/js/tether.min.js"></script>
<script src="plugins/raty/jquery.raty-fa.js"></script>
<script src="plugins/bootstrap/dist/js/popper.min.js"></script>
<script src="plugins/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="plugins/seiyria-bootstrap-slider/dist/bootstrap-slider.min.js"></script>
<script src="plugins/slick-carousel/slick/slick.min.js"></script>
<script src="plugins/jquery-nice-select/js/jquery.nice-select.min.js"></script>
<script src="plugins/fancybox/jquery.fancybox.pack.js"></script>
<script src="plugins/smoothscroll/SmoothScroll.min.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCC72vZw-6tGqFyRhhg5CkF2fqfILn2Tsw"></script>
<script src="js/scripts.js"></script>
<script src="/frameWork/jquery/jquery-3.7.1.min.js"></script>
<script src="frameWork/sweetalert2/sweetalert2.all.min.js"></script>
<script src="js/profile.js"></script>
<script>
    $(document).ready(function () {
        const token = localStorage.getItem('token');

        if (!token) {
            console.error("Token not found!");
            return;
        }

        // Function to decode JWT and extract email
        function getEmailFromToken(token) {
            try {
                const payload = JSON.parse(atob(token.split('.')[1])); // Decode JWT payload
                return payload.sub || payload.email || ""; // Extract email (assuming 'sub' or 'email' holds it)
            } catch (error) {
                console.error("Error decoding token:", error);
                return "";
            }
        }

        // Get email from token
        const email = getEmailFromToken(token);
        console.log("Extracted email:", email);
        $("#email").val(email); // Set email in text field

        // Load user details via API
        $.ajax({
            url: 'http://localhost:8080/api/v1/user/get',
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token
            },
            success: function (response) {
                console.log("API Response:", response);
                const user = response; // Adjust if response contains 'data'

                $("#email").val(user.email || email); // Use API email if available
                $("#contact").val(user.contact || "");
                $("#address").val(user.address || "");

                if (user.name) {
                    const names = user.name.split(' ');
                    $("#first-name").val(names[0] || "");
                    $("#last-name").val(names.slice(1).join(' ') || "");
                }
            },
            error: function (xhr, status, error) {
                console.error("Error fetching user data:", xhr.responseText);
            }
        });

        // Debug: Check localStorage contents
        console.log("LocalStorage contents:", localStorage);
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user'));

        if (!token) {
            console.error("No token found - redirecting to login");
            window.location.href = "login.html";
            return;
        }

        // Load existing profile data
        if (user) {
            $('#first-name').val(user.firstName || '');
            $('#last-name').val(user.lastName || '');
            $('#email').val(user.email || '');
            $('#address').val(user.address || '');
            $('#contact').val(user.contact || '');

            if (user.image) {
                $('#image-preview').attr('src', user.image).show();
            }
        }

        // Handle profile picture preview
        $('#input-file').change(function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    $('#image-preview').attr('src', e.target.result).show();
                }
                reader.readAsDataURL(file);
            }
        });

        // Handle form submission
        $('#profile-form').submit(function (event) {
            event.preventDefault();

            const submitBtn = $(this).find('button[type="submit"]');
            submitBtn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Saving...');

            // Create FormData for potential file upload
            const formData = new FormData();
            formData.append('firstName', $('#first-name').val());
            formData.append('lastName', $('#last-name').val());
            formData.append('email', $('#email').val());
            formData.append('address', $('#address').val());
            formData.append('contact', $('#contact').val());

            // Append file if selected
            const fileInput = $('#input-file')[0];
            if (fileInput.files[0]) {
                formData.append('image', fileInput.files[0]);
            }

            // Debug: Log the data being sent
            console.log("Submitting profile update with data:", {
                firstName: $('#first-name').val(),
                lastName: $('#last-name').val(),
                email: $('#email').val(),
                address: $('#address').val(),
                contact: $('#contact').val(),
                hasImage: !!fileInput.files[0]
            });

            $.ajax({
                url: 'http://localhost:8080/api/v1/profile/update',
                method: 'PUT',
                data: formData,
                processData: false,
                contentType: false,
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                success: function (response) {
                    console.log("Update successful:", response);

                    // Update local user data
                    if (response.data) {
                        localStorage.setItem('user', JSON.stringify(response.data));
                        $('#profile-name').text(response.data.firstName + ' ' + response.data.lastName);

                        if (response.data.image) {
                            $('#image-preview').attr('src', response.data.image);
                        }
                    }

                    Swal.fire({
                        icon: 'success',
                        title: 'Profile Updated!',
                        text: 'Your changes have been saved successfully.',
                        timer: 2000
                    });
                },
                error: function (xhr, status, error) {
                    console.error("Update error:", {
                        status: xhr.status,
                        error: error,
                        response: xhr.responseText
                    });

                    let errorMessage = "Failed to update profile. Please try again.";
                    if (xhr.status === 401) {
                        errorMessage = "Session expired. Please login again.";
                        localStorage.clear();
                        setTimeout(() => window.location.href = "login.html", 1500);
                    } else if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    }

                    Swal.fire({
                        icon: 'error',
                        title: 'Update Failed',
                        text: errorMessage
                    });
                },
                complete: function() {
                    submitBtn.prop('disabled', false).text('Save Changes');
                }
            });
        });
    });




</script>
</body>
</html>