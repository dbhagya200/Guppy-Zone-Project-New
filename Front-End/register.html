<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Register</title>
    <link href="css/register.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="/frameWork/bootstrap/bootstrap.min.css" rel="stylesheet">
    <link rel="shortcut icon" href="img/logo-new.png" type="image/x-icon" />
</head>
<body>
<div id="container" class="container">
    <div style="color: white;display: flex;justify-content: space-between;margin: 10px 20px;text-decoration: none">
        <a href="index-1.html" >
            <i class="fas fa-arrow-left"
               style="font-size: 20px;background-color: #57B894FF;padding: 10px;border-radius: 50%;color: white"></i>
        </a>
        <a href="index-1.html" >
            <i class="fas fa-arrow-left"
               style="font-size: 20px;background-color: #57B894FF;padding: 10px;border-radius: 50%;color: white" ></i>
        </a>
    </div>

    <!-- FORM SECTION -->
    <div class="row">

        <!-- SIGN UP -->
        <div class="col align-items-center flex-col sign-up">

            <div class="form-wrapper align-items-center">

                <div class="form sign-up">
<!--                    <div class="input-group">-->
<!--                        <i class='bx bxs-user'></i>-->
<!--                        <input type="text" id="name" class="form-control" placeholder="Username" required>-->
<!--                    </div>-->
<!--                    <div class="input-group">-->
<!--                        <i class='bx bx-mail-send'></i>-->
<!--                        <input type="email" id="email" class="form-control" placeholder="Email" required>-->
<!--                    </div>-->
<!--                    <div class="mb-3">-->
<!--                        <i class='bx bx-mail-send'></i>-->
<!--                        <select class="form-select "  id="role" required>-->
<!--                            <option value="" >Select a role</option>-->
<!--                            <option value="BUYER">BUYER</option>-->
<!--                            <option value="SELLER">SELLER</option>-->
<!--                            &lt;!&ndash;                    <option value="ADMIN">ADMIN</option>&ndash;&gt;-->
<!--                        </select>-->
<!--                    </div>-->
<!--                    <div class="input-group">-->
<!--                        <i class='bx bxs-lock-alt'></i>-->
<!--                        <input type="password" id="password" class="form-control" placeholder="Password" required>-->
<!--                    </div>-->
<!--                    <div class="input-group">-->
<!--                        <i class='bx bxs-lock-alt'></i>-->
<!--                        <input type="password" id="confirm-password" class="form-control" placeholder="Confirm password" required>-->
<!--                    </div>-->
<!--                    <button id="registerBtn" type="button" class="btn">-->
<!--                        Sign up-->
<!--                    </button>-->

                    <form >
                        <div class="mb-3 input-group">
                            <!--                <label for="name" class="form-label">Full Name</label>-->
                            <input  type="text" class="form-control " id="name" placeholder="Enter your  Username" required>
                        </div>
                        <div class="mb-3 input-group">
                            <!--                <label for="email" class="form-label">Email address</label>-->
                            <input type="email" class="form-control" id="email" placeholder="Enter your email" required>
                        </div>
                        <div class="mb-3 input-group">
                            <!--                <label for="category" class="form-label">Category</label>-->
                            <select class="form-select "  id="role" required>
                                <option value="" style="font-family: aakari;">Select a role</option>
                                <option value="BUYER">BUYER</option>
                                <option value="SELLER">SELLER</option>
                                <!--                    <option value="ADMIN">ADMIN</option>-->
                            </select>
                        </div>
                        <div class="mb-3 input-group">
                            <!--                <label for="password" class="form-label">Password</label>-->
                            <input type="password" class="form-control" id="password" placeholder="Enter password" required>
                        </div>
                        <div class="mb-3 input-group">
                            <!--                <label for="confirm-password" class="form-label">Confirm Password</label>-->
                            <input type="password" class="form-control" id="confirm-password" placeholder="Confirm password" required>
                        </div>
                        <button id="registerBtn" type="button" class="btn btn-success w-100">Register</button>
                    </form>
                    <p>
							<span>
								Already have an account?
							</span>
                        <b onclick="toggle()" class="pointer">
                            Sign in here
                        </b>
                    </p>
                </div>
            </div>

        </div>
        <!-- END SIGN UP -->
        <!-- SIGN IN -->
        <div class="col align-items-center flex-col sign-in">
            <div class="form-wrapper align-items-center">
                <div class="form sign-in">
                    <div class="input-group">
                        <i class='bx bxs-user'></i>
                        <input type="email" id="name-login" placeholder="Email" class="form-control" required autocomplete="current-name">
                    </div>
                    <div class="input-group">
                        <i class='bx bxs-lock-alt'></i>
                        <input type="password" id="password-login" placeholder="Password" class="form-control" required autocomplete="current-name">
                    </div>
                    <button id="loginBtn" type="button" class="btn">
                        Sign in
                    </button>
                    <p>
                        <b>
                            <a href="#" class="pointer">
                                Forgot password?
                            </a>

                        </b>
                    </p>
                    <p>
							<span>
								Don't have an account?
							</span>
                        <b onclick="toggle()" class="pointer">
                            Sign up here
                        </b>

                    </p>
                </div>
            </div>
            <div class="form-wrapper">

            </div>
        </div>
        <!-- END SIGN IN -->
    </div>
    <!-- END FORM SECTION -->
    <!-- CONTENT SECTION -->
    <div class="row content-row">

        <!-- SIGN IN CONTENT -->
        <div class="col align-items-center flex-col">

            <div class="text sign-in">

                <h2>
                    Welcome
                </h2>

            </div>
            <div class="img sign-in">

            </div>
        </div>
        <!-- END SIGN IN CONTENT -->
        <!-- SIGN UP CONTENT -->
        <div class="col align-items-center flex-col">
            <div class="img sign-up">

            </div>
            <div class="text sign-up">
                <h2>
                    Join with us
                </h2>

            </div>
        </div>
        <!-- END SIGN UP CONTENT -->
    </div>
    <!-- END CONTENT SECTION -->
</div>
<script src="js/register.js"></script>
<!--<script src="js/signup-login.js"></script>-->
<script src="/frameWork/jquery/jquery-3.7.1.min.js"></script>
<script src="frameWork/sweetalert2/sweetalert2.all.min.js"></script>
<script>
    $(document).ready(function() {
        $('#registerBtn').click(function () {
            // Get form values
            let name = $('#name').val().trim();
            let email = $('#email').val().trim();
            let password = $('#password').val();
            let confirmPassword = $('#confirm-password').val();
            let selectedValue = $('#role').val();

            if (!name || !email || !password || !confirmPassword || !selectedValue) {
                Swal.fire({
                    icon: "error",
                    title: "Missing Information",
                    text: "Please fill in all fields",
                });
                return;
            }

            if (password !== confirmPassword) {
                Swal.fire({
                    icon: "error",
                    title: "Password Mismatch",
                    text: "Password and Confirm Password do not match",
                });
                return;
            }

            if (password.length < 8) {
                Swal.fire({
                    icon: "error",
                    title: "Weak Password",
                    text: "Password must be at least 8 characters long",
                });
                return;
            }

            Swal.fire({
                title: "Complete Registration?",
                text: "You will be redirected to login page after successful registration.",
                icon: "question",
                showCancelButton: true,
                confirmButtonColor: "#034a58",
                cancelButtonColor: "#57b894",
                confirmButtonText: "Register"
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.showLoading();
                    $.ajax({
                        url: 'http://localhost:8080/api/v1/user/register',
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({
                            "username": name,
                            "email": email,
                            "password": password,
                            "role": selectedValue
                        }),
                        success: function(response) {
                            if (response.data && response.data.token) {
                                localStorage.setItem("token", response.data.token);
                            }

                            Swal.fire({
                                icon: "success",
                                title: "Success",
                                text: "Registration Successful! Please login.",
                                timer: 2000,
                                showConfirmButton: false
                            }).then(() => {
                                window.location.href = "register.html";
                            });
                        },
                        error: function(xhr) {
                            Swal.hideLoading();

                            if (xhr.status === 400) {
                                let errors = xhr.responseJSON?.errors || [];
                                let errorMessage = errors.map(e => e.message).join('\n');

                                Swal.fire({
                                    icon: "error",
                                    title: "Validation Error",
                                    text: errorMessage || "Please check your input",
                                });
                            } else if (xhr.status === 409) {
                                Swal.fire({
                                    icon: "error",
                                    title: "Registration Failed",
                                    text: xhr.responseJSON?.message || "User already exists",
                                });
                            } else {
                                Swal.fire({
                                    icon: "error",
                                    title: "Registration Failed",
                                    text: xhr.responseJSON?.message || "Something went wrong. Please try again.",
                                });
                            }
                        }
                    });
                }
            });
        });

        fetch('http://localhost:8080/api/v1/user/me', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        })
            .then(response => response.json())
            .then(data => console.log(data));

        function showFieldError(fieldId, message) {
            $(fieldId).addClass('is-invalid');
            $(fieldId).next('.invalid-feedback').text(message);
        }


        $('#loginBtn').click(function (){
            let name = $('#name-login').val();
            let password = $('#password-login').val();

            $.ajax({
                url: 'http://localhost:8080/api/v1/auth/authenticate',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    "email": name,
                    "password": password
                    // "name": "USER",
                    // "role": "USER"
                }),
                success: function(response) {
                    localStorage.setItem("token", response.data.token);
                    Swal.fire({
                        icon: "success",
                        title: "Success",
                        text: "Login Successful!",
                    }).then(() => {
                        switch(response.data.role) {
                            case "SELLER":
                                window.location.href = "home.html";
                                break;
                            case "BUYER":
                                window.location.href = "buyerHome.html";
                                break;
                            case "ADMIN":
                                window.location.href = "adminHome.html";
                                break;
                            default:
                                console.error("Unknown role:", response.data.role);
                                window.location.href = "index-1.html";
                        }
                    });
                },
                error: function (error) {
                    Swal.fire({
                        icon: "error",
                        title: "Oops...",
                        text: " Something went wrong!",
                    }).then(() => {
                        window.location.href = "register.html";
                    });
                }
            });




        });


        function errorAlert(message){
            showAlert("error","Oops...",message)
        }
    });
</script>
</body>
</html>